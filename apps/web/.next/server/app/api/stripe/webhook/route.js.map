{"version":3,"file":"../app/api/stripe/webhook/route.js","mappings":"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","sources":["webpack://@hijraah/web/external commonjs \"next/dist/server/app-render/after-task-async-storage.external.js\"","webpack://@hijraah/web/external commonjs2 \"module\"","webpack://@hijraah/web/../../node_modules/.pnpm/@opentelemetry+instrumentat_04f370d515cee0be955272f826166073/node_modules/@opentelemetry/instrumentation/build/esm/platform/node/ sync","webpack://@hijraah/web/external commonjs \"next/dist/compiled/next-server/app-page.runtime.prod.js\"","webpack://@hijraah/web/external commonjs2 \"punycode\"","webpack://@hijraah/web/external commonjs2 \"process\"","webpack://@hijraah/web/external commonjs2 \"os\"","webpack://@hijraah/web/external commonjs2 \"stream\"","webpack://@hijraah/web/external commonjs2 \"util\"","webpack://@hijraah/web/external commonjs2 \"fs\"","webpack://@hijraah/web/external commonjs \"next/dist/server/app-render/work-async-storage.external.js\"","webpack://@hijraah/web/external node-commonjs \"node:child_process\"","webpack://@hijraah/web/./src/lib/logger/index.ts","webpack://@hijraah/web/external commonjs2 \"path\"","webpack://@hijraah/web/external commonjs2 \"tls\"","webpack://@hijraah/web/external commonjs2 \"diagnostics_channel\"","webpack://@hijraah/web/external node-commonjs \"node:http\"","webpack://@hijraah/web/external node-commonjs \"node:zlib\"","webpack://@hijraah/web/external node-commonjs \"node:tls\"","webpack://@hijraah/web/external node-commonjs \"node:https\"","webpack://@hijraah/web/external commonjs \"next/dist/compiled/next-server/app-route.runtime.prod.js\"","webpack://@hijraah/web/external node-commonjs \"node:os\"","webpack://@hijraah/web/external node-commonjs \"node:diagnostics_channel\"","webpack://@hijraah/web/external commonjs2 \"crypto\"","webpack://@hijraah/web/external commonjs2 \"https\"","webpack://@hijraah/web/external node-commonjs \"node:stream\"","webpack://@hijraah/web/external node-commonjs \"node:util\"","webpack://@hijraah/web/ignored|E:\\downloads\\Hijraah\\node_modules\\.pnpm\\ws@8.18.2_bufferutil@4.0.9\\node_modules\\ws\\lib|utf-8-validate","webpack://@hijraah/web/external commonjs \"next/dist/server/app-render/work-unit-async-storage.external.js\"","webpack://@hijraah/web/external node-commonjs \"node:fs\"","webpack://@hijraah/web/external commonjs2 \"worker_threads\"","webpack://@hijraah/web/external commonjs2 \"zlib\"","webpack://@hijraah/web/external commonjs2 \"perf_hooks\"","webpack://@hijraah/web/external node-commonjs \"node:worker_threads\"","webpack://@hijraah/web/external node-commonjs \"node:path\"","webpack://@hijraah/web/external node-commonjs \"node:net\"","webpack://@hijraah/web/external commonjs2 \"buffer\"","webpack://@hijraah/web/external commonjs2 \"url\"","webpack://@hijraah/web/external commonjs2 \"child_process\"","webpack://@hijraah/web/external node-commonjs \"node:readline\"","webpack://@hijraah/web/external commonjs2 \"http\"","webpack://@hijraah/web/external commonjs2 \"tty\"","webpack://@hijraah/web/external commonjs2 \"async_hooks\"","webpack://@hijraah/web/external node-commonjs \"node:inspector\"","webpack://@hijraah/web/external commonjs2 \"net\"","webpack://@hijraah/web/src/app/api/stripe/webhook/route.ts","webpack://@hijraah/web/sentry-wrapper-module","webpack://@hijraah/web/?2242","webpack://@hijraah/web/external commonjs2 \"events\"","webpack://@hijraah/web/../../node_modules/.pnpm/require-in-the-middle@7.5.2/node_modules/require-in-the-middle/ sync","webpack://@hijraah/web/../../node_modules/.pnpm/@supabase+realtime-js@2.11.10_bufferutil@4.0.9/node_modules/@supabase/realtime-js/dist/main/ sync"],"sourcesContent":["module.exports = require(\"next/dist/server/app-render/after-task-async-storage.external.js\");","module.exports = require(\"module\");","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 8963;\nmodule.exports = webpackEmptyContext;","module.exports = require(\"next/dist/compiled/next-server/app-page.runtime.prod.js\");","module.exports = require(\"punycode\");","module.exports = require(\"process\");","module.exports = require(\"os\");","module.exports = require(\"stream\");","module.exports = require(\"util\");","module.exports = require(\"fs\");","module.exports = require(\"next/dist/server/app-render/work-async-storage.external.js\");","module.exports = require(\"node:child_process\");","type LogLevel = 'debug' | 'info' | 'warn' | 'error';\r\n\r\ninterface LogEntry {\r\n  level: LogLevel;\r\n  message: string;\r\n  timestamp: string;\r\n  context?: Record<string, unknown>;\r\n}\r\n\r\nclass Logger {\r\n  private static instance: Logger;\r\n  private logLevel: LogLevel = 'info';\r\n  private buffer: LogEntry[] = [];\r\n  private readonly maxBufferSize = 1000;\r\n\r\n  private constructor() {\r\n    // Set log level from environment\r\n    const envLogLevel = process.env.LOG_LEVEL as LogLevel;\r\n    if (envLogLevel && ['debug', 'info', 'warn', 'error'].includes(envLogLevel)) {\r\n      this.logLevel = envLogLevel;\r\n    }\r\n  }\r\n\r\n  public static getInstance(): Logger {\r\n    if (!Logger.instance) {\r\n      Logger.instance = new Logger();\r\n    }\r\n    return Logger.instance;\r\n  }\r\n\r\n  private shouldLog(level: LogLevel): boolean {\r\n    const levels: Record<LogLevel, number> = {\r\n      debug: 0,\r\n      info: 1,\r\n      warn: 2,\r\n      error: 3,\r\n    };\r\n    return levels[level] >= levels[this.logLevel];\r\n  }\r\n\r\n  private formatMessage(entry: LogEntry): string {\r\n    const context = entry.context ? ` ${JSON.stringify(entry.context)}` : '';\r\n    return `[${entry.timestamp}] ${entry.level.toUpperCase()}: ${entry.message}${context}`;\r\n  }\r\n\r\n  private addToBuffer(entry: LogEntry) {\r\n    this.buffer.push(entry);\r\n    if (this.buffer.length > this.maxBufferSize) {\r\n      this.buffer.shift();\r\n    }\r\n  }\r\n\r\n  private createLogEntry(level: LogLevel, message: string, context?: Record<string, unknown>): LogEntry {\r\n    return {\r\n      level,\r\n      message,\r\n      timestamp: new Date().toISOString(),\r\n      context,\r\n    };\r\n  }\r\n\r\n  public debug(message: string, context?: Record<string, unknown>) {\r\n    if (this.shouldLog('debug')) {\r\n      const entry = this.createLogEntry('debug', message, context);\r\n      this.addToBuffer(entry);\r\n      if (process.env.NODE_ENV === 'development') {\r\n        console.debug(this.formatMessage(entry));\r\n      }\r\n    }\r\n  }\r\n\r\n  public info(message: string, context?: Record<string, unknown>) {\r\n    if (this.shouldLog('info')) {\r\n      const entry = this.createLogEntry('info', message, context);\r\n      this.addToBuffer(entry);\r\n      console.info(this.formatMessage(entry));\r\n    }\r\n  }\r\n\r\n  public warn(message: string, context?: Record<string, unknown>) {\r\n    if (this.shouldLog('warn')) {\r\n      const entry = this.createLogEntry('warn', message, context);\r\n      this.addToBuffer(entry);\r\n      console.warn(this.formatMessage(entry));\r\n    }\r\n  }\r\n\r\n  public error(message: string, error?: Error, context?: Record<string, unknown>) {\r\n    if (this.shouldLog('error')) {\r\n      const errorContext = error ? {\r\n        ...context,\r\n        error: {\r\n          name: error.name,\r\n          message: error.message,\r\n          stack: error.stack,\r\n        },\r\n      } : context;\r\n\r\n      const entry = this.createLogEntry('error', message, errorContext);\r\n      this.addToBuffer(entry);\r\n      console.error(this.formatMessage(entry));\r\n    }\r\n  }\r\n\r\n  public getBuffer(): LogEntry[] {\r\n    return [...this.buffer];\r\n  }\r\n\r\n  public clearBuffer() {\r\n    this.buffer = [];\r\n  }\r\n\r\n  public setLogLevel(level: LogLevel) {\r\n    this.logLevel = level;\r\n  }\r\n}\r\n\r\nexport const logger = Logger.getInstance(); ","module.exports = require(\"path\");","module.exports = require(\"tls\");","module.exports = require(\"diagnostics_channel\");","module.exports = require(\"node:http\");","module.exports = require(\"node:zlib\");","module.exports = require(\"node:tls\");","module.exports = require(\"node:https\");","module.exports = require(\"next/dist/compiled/next-server/app-route.runtime.prod.js\");","module.exports = require(\"node:os\");","module.exports = require(\"node:diagnostics_channel\");","module.exports = require(\"crypto\");","module.exports = require(\"https\");","module.exports = require(\"node:stream\");","module.exports = require(\"node:util\");","/* (ignored) */","module.exports = require(\"next/dist/server/app-render/work-unit-async-storage.external.js\");","module.exports = require(\"node:fs\");","module.exports = require(\"worker_threads\");","module.exports = require(\"zlib\");","module.exports = require(\"perf_hooks\");","module.exports = require(\"node:worker_threads\");","module.exports = require(\"node:path\");","module.exports = require(\"node:net\");","module.exports = require(\"buffer\");","module.exports = require(\"url\");","module.exports = require(\"child_process\");","module.exports = require(\"node:readline\");","module.exports = require(\"http\");","module.exports = require(\"tty\");","module.exports = require(\"async_hooks\");","module.exports = require(\"node:inspector\");","module.exports = require(\"net\");","import { createClient } from '@supabase/supabase-js';\r\nimport { headers } from 'next/headers';\r\nimport { NextResponse } from 'next/server';\r\nimport Stripe from 'stripe';\r\n\r\nimport { logger } from '@/lib/logger';\r\n\r\nconst supabase = createClient(\r\n  process.env.NEXT_PUBLIC_SUPABASE_URL!,\r\n  process.env.SUPABASE_SERVICE_ROLE_KEY!\r\n);\r\n\r\nexport async function POST(req: Request) {\r\n  logger.info('Initializing Stripe within webhook POST handler...');\r\n  logger.info(`STRIPE_SECRET_KEY availability: ${!!process.env.STRIPE_SECRET_KEY}`);\r\n  if (!process.env.STRIPE_SECRET_KEY || !process.env.STRIPE_WEBHOOK_SECRET) {\r\n    logger.error('Stripe environment variables (STRIPE_SECRET_KEY or STRIPE_WEBHOOK_SECRET) are missing!');\r\n    return NextResponse.json({ error: 'Stripe configuration error' }, { status: 500 });\r\n  }\r\n  const stripe = new Stripe(process.env.STRIPE_SECRET_KEY!, {\r\n    apiVersion: '2024-11-20.acacia',\r\n  });\r\n  const webhookSecret = process.env.STRIPE_WEBHOOK_SECRET!;\r\n  logger.info('Stripe initialized successfully within webhook POST handler.');\r\n\r\n  try {\r\n    const body = await req.text();\r\n    const headersList = await headers();\r\n    const signature = headersList.get('stripe-signature');\r\n\r\n    if (!signature) {\r\n      return NextResponse.json(\r\n        { error: 'No signature found' },\r\n        { status: 400 }\r\n      );\r\n    }\r\n\r\n    const event = stripe.webhooks.constructEvent(\r\n      body,\r\n      signature,\r\n      webhookSecret\r\n    );\r\n\r\n    switch (event.type) {\r\n      case 'checkout.session.completed': {\r\n        const session = event.data.object as Stripe.Checkout.Session;\r\n        const userId = session.metadata?.userId;\r\n\r\n        if (userId) {\r\n          const { error } = await supabase.auth.admin.updateUserById(userId, {\r\n            user_metadata: {\r\n              subscription_status: 'active',\r\n              stripe_customer_id: session.customer as string,\r\n              subscription_plan: session.metadata?.plan,\r\n            }\r\n          });\r\n\r\n          if (error) throw error;\r\n        }\r\n        break;\r\n      }\r\n\r\n      case 'customer.subscription.deleted': {\r\n        const subscription = event.data.object as Stripe.Subscription;\r\n        const customerId = subscription.customer as string;\r\n\r\n        // Find user by stripe customer ID and update\r\n        const { data: { users }, error: findError } = await supabase.auth.admin.listUsers();\r\n        const user = users.find(u => u.user_metadata?.stripe_customer_id === customerId);\r\n\r\n        if (user && !findError) {\r\n          const { error } = await supabase.auth.admin.updateUserById(user.id, {\r\n            user_metadata: {\r\n              subscription_status: 'inactive',\r\n              subscription_plan: null,\r\n            }\r\n          });\r\n\r\n          if (error) throw error;\r\n        }\r\n        break;\r\n      }\r\n    }\r\n\r\n    return NextResponse.json({ received: true });\r\n  } catch (error) {\r\n    logger.error('Error handling Stripe webhook:', { \r\n      error: error instanceof Error ? error.message : 'Unknown error' \r\n    });\r\n    return NextResponse.json(\r\n      { error: 'Error handling webhook' },\r\n      { status: 400 }\r\n    );\r\n  }\r\n}","import * as origModule from 'next/dist/server/app-render/work-unit-async-storage.external.js';\nimport * as serverComponentModule from '__SENTRY_WRAPPING_TARGET_FILE__.cjs';\nexport * from '__SENTRY_WRAPPING_TARGET_FILE__.cjs';\nexport {} from '__SENTRY_WRAPPING_TARGET_FILE__.cjs';\nimport * as Sentry from '@sentry/nextjs';\n\n// @ts-expect-error Because we cannot be sure if the RequestAsyncStorage module exists (it is not part of the Next.js public\n// API) we use a shim if it doesn't exist. The logic for this is in the wrapping loader.\n\nconst asyncStorageModule = { ...origModule } ;\n\nconst requestAsyncStorage =\n  'workUnitAsyncStorage' in asyncStorageModule\n    ? asyncStorageModule.workUnitAsyncStorage\n    : 'requestAsyncStorage' in asyncStorageModule\n      ? asyncStorageModule.requestAsyncStorage\n      : undefined;\n\nfunction wrapHandler(handler, method) {\n  // Running the instrumentation code during the build phase will mark any function as \"dynamic\" because we're accessing\n  // the Request object. We do not want to turn handlers dynamic so we skip instrumentation in the build phase.\n  if (process.env.NEXT_PHASE === 'phase-production-build') {\n    return handler;\n  }\n\n  if (typeof handler !== 'function') {\n    return handler;\n  }\n\n  return new Proxy(handler, {\n    apply: (originalFunction, thisArg, args) => {\n      let headers = undefined;\n\n      // We try-catch here just in case the API around `requestAsyncStorage` changes unexpectedly since it is not public API\n      try {\n        const requestAsyncStore = requestAsyncStorage?.getStore() ;\n        headers = requestAsyncStore?.headers;\n      } catch (e) {\n        /** empty */\n      }\n\n      // eslint-disable-next-line @typescript-eslint/no-explicit-any\n      return Sentry.wrapRouteHandlerWithSentry(originalFunction , {\n        method,\n        parameterizedRoute: '/api/stripe/webhook',\n        headers,\n      }).apply(thisArg, args);\n    },\n  });\n}\n\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst GET = wrapHandler(serverComponentModule.GET , 'GET');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst POST = wrapHandler(serverComponentModule.POST , 'POST');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst PUT = wrapHandler(serverComponentModule.PUT , 'PUT');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst PATCH = wrapHandler(serverComponentModule.PATCH , 'PATCH');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst DELETE = wrapHandler(serverComponentModule.DELETE , 'DELETE');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst HEAD = wrapHandler(serverComponentModule.HEAD , 'HEAD');\n// eslint-disable-next-line @typescript-eslint/no-unsafe-member-access\nconst OPTIONS = wrapHandler(serverComponentModule.OPTIONS , 'OPTIONS');\n\nexport { DELETE, GET, HEAD, OPTIONS, PATCH, POST, PUT };\n","import { AppRouteRouteModule } from \"next/dist/server/route-modules/app-route/module.compiled\";\nimport { RouteKind } from \"next/dist/server/route-kind\";\nimport { patchFetch as _patchFetch } from \"next/dist/server/lib/patch-fetch\";\nimport * as userland from \"E:\\\\downloads\\\\Hijraah\\\\apps\\\\web\\\\src\\\\app\\\\api\\\\stripe\\\\webhook\\\\route.ts\";\n// We inject the nextConfigOutput here so that we can use them in the route\n// module.\nconst nextConfigOutput = \"\"\nconst routeModule = new AppRouteRouteModule({\n    definition: {\n        kind: RouteKind.APP_ROUTE,\n        page: \"/api/stripe/webhook/route\",\n        pathname: \"/api/stripe/webhook\",\n        filename: \"route\",\n        bundlePath: \"app/api/stripe/webhook/route\"\n    },\n    resolvedPagePath: \"E:\\\\downloads\\\\Hijraah\\\\apps\\\\web\\\\src\\\\app\\\\api\\\\stripe\\\\webhook\\\\route.ts\",\n    nextConfigOutput,\n    userland\n});\n// Pull out the exports that we need to expose from the module. This should\n// be eliminated when we've moved the other routes to the new format. These\n// are used to hook into the route.\nconst { workAsyncStorage, workUnitAsyncStorage, serverHooks } = routeModule;\nfunction patchFetch() {\n    return _patchFetch({\n        workAsyncStorage,\n        workUnitAsyncStorage\n    });\n}\nexport { routeModule, workAsyncStorage, workUnitAsyncStorage, serverHooks, patchFetch,  };\n\n//# sourceMappingURL=app-route.js.map","module.exports = require(\"events\");","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 96708;\nmodule.exports = webpackEmptyContext;","function webpackEmptyContext(req) {\n\tvar e = new Error(\"Cannot find module '\" + req + \"'\");\n\te.code = 'MODULE_NOT_FOUND';\n\tthrow e;\n}\nwebpackEmptyContext.keys = () => ([]);\nwebpackEmptyContext.resolve = webpackEmptyContext;\nwebpackEmptyContext.id = 97108;\nmodule.exports = webpackEmptyContext;"],"names":["Logger","logLevel","buffer","maxBufferSize","envLogLevel","process","env","LOG_LEVEL","includes","getInstance","instance","shouldLog","level","levels","debug","info","warn","error","formatMessage","entry","context","JSON","stringify","timestamp","toUpperCase","message","addToBuffer","push","length","shift","createLogEntry","Date","toISOString","console","errorContext","name","stack","getBuffer","clearBuffer","setLogLevel","logger","supabase","createClient","SUPABASE_SERVICE_ROLE_KEY","POST","req","STRIPE_SECRET_KEY","STRIPE_WEBHOOK_SECRET","NextResponse","json","status","stripe","Stripe","apiVersion","webhookSecret","body","text","signature","headers","get","event","webhooks","constructEvent","type","session","data","object","userId","metadata","auth","admin","updateUserById","user_metadata","subscription_status","stripe_customer_id","customer","subscription_plan","plan","customerId","users","findError","listUsers","user","u","id","received","Error","serverComponentModule.GET","serverComponentModule.PUT","serverComponentModule.PATCH","serverComponentModule.DELETE","serverComponentModule.HEAD","serverComponentModule.OPTIONS"],"sourceRoot":""}